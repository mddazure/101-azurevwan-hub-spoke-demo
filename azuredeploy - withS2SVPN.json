{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "adminUsername": {
            "type": "string",
            "defaultValue": "marc",
            "metadata": {
                "description":"Username for the VMs"
            }
          },
          "adminPassword": {
            "type": "securestring",
            "defaultValue": "Nienke040598",
            "metadata": {
                "description":"Password for the VMs"
            }
          } 
    },
    "variables": {
        "vpnSites_Onprem_1_name": "Onprem-1",  

        "virtualWans_Demo_vWAN_name": "Demo-vWAN",

        "virtualMachines_onprem_name": "onprem",
        "virtualMachines_vwan_1_name": "vwan-1",
        "virtualMachines_vwan_2_name": "vwan-2",
        "virtualMachines_vwan_3_name": "vwan-3",
        "virtualMachines_vwan_4_name": "vwan-4",

        "virtualHubs_Demo_WE_Hub_name": "Demo-WE-Hub",

        "virtualNetworks_spoke_1_name": "spoke-1",
        "virtualNetworks_spoke_2_name": "spoke-2",
        "virtualNetworks_spoke_3_name": "spoke-3",
        "virtualNetworks_spoke_4_name": "spoke-4",
        "virtualNetworks_onprem_name": "onprem",

        "networkInterfaces_onprem_name":  "onpremnic",
        "networkInterfaces_vwan_1_name": "vwan-1nic",
        "networkInterfaces_vwan_2_name": "vwan-2nic",
        "networkInterfaces_vwan_3_name": "vwan-3nic",
        "networkInterfaces_vwan_4_name": "vwan-4nic",

        "firewallPolicies_Demo_vWAN_name": "Demo-vWAN",
        
        "publicIPAddresses_spoke_1_ip_name": "spoke-1-ip",
        "publicIPAddresses_spoke_2_ip_name": "spoke-2-ip",
        "publicIPAddresses_spoke_3_ip_name": "spoke-3-ip",
        "publicIPAddresses_spoke_4_ip_name": "spoke-4-ip",
        "publicIPAddresses_onprem_vm_pubip_name": "onprem-vm-pubip",
        "publicIPAddresses_vwan_on_prem_gw_pub_ip_name": "vwan-on-prem-gw-pub-ip",

        "localNetworkGateways_vwan_hub_name": "vwan-hub",

        "storageAccounts_demovwanrgdiag_name": "[uniquestring(resourceGroup().id)]",
            
        "networkSecurityGroups_onprem_nsg_name": "onprem-nsg",
        "networkSecurityGroups_vwan_1_nsg_name": "vwan-1-nsg",
        "networkSecurityGroups_vwan_2_nsg_name": "vwan-2-nsg",
        "networkSecurityGroups_vwan_3_nsg_name": "vwan-3-nsg",
        "networkSecurityGroups_vwan_4_nsg_name": "vwan-4-nsg",
       
        "vpnGateways_westeurope_gw_name": "[concat(uniquestring(resourceGroup().id),'-westeurope-gw')]",

        "virtualNetworkGateways_vwan_on_prem_gw_name": "vwan-on-prem-gw",
        "virtualNetworkGateways_shared_key":"[uniquestring(deployment().name)]"   
    },
    "resources": [
        {
            "type": "Microsoft.Network/virtualNetworkGateways",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualNetworkGateways_vwan_on_prem_gw_name')]",
            "location": "northeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_vwan_on_prem_gw_pub_ip_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_onprem_name'), 'GatewaySubnet')]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "default",
                        "properties": {
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_vwan_on_prem_gw_pub_ip_name'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_onprem_name'), 'GatewaySubnet')]"
                            }
                        }
                    }
                ],
                "sku": {
                    "name": "VpnGw1",
                    "tier": "VpnGw1"
                },
                "gatewayType": "Vpn",
                "vpnType": "RouteBased",
                "enableBgp": true,
                "activeActive": false,
                "vpnClientConfiguration": {
                    "vpnClientProtocols": [
                        "OpenVPN",
                        "IkeV2"
                    ]
                },
                "bgpSettings": {
                    "asn": 65515,
                    "peerWeight": 0
                },
                "vpnGatewayGeneration": "Generation1"
            }
        },
        {
            "type": "Microsoft.Network/localNetworkGateways",
            "apiVersion": "2019-09-01",
            "name": "[variables('localNetworkGateways_vwan_hub_name')]",
            "location": "westeurope",
            "properties": {
                "localNetworkAddressSpace": {
                    "addressPrefixes": [
                        "172.16.1.0/24",
                        "172.16.2.0/24",
                        "172.16.3.0/24",
                        "172.16.4.0/24"
                    ]
                },
                "gatewayIpAddress": "51.137.4.84"
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('networkSecurityGroups_onprem_nsg_name')]",
            "location": "northeurope",
            "properties": {
                "securityRules": [
                    {
                        "name": "RDP",
                        "properties": {
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 300,
                            "direction": "Inbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('networkSecurityGroups_vwan_1_nsg_name')]",
            "location": "westeurope",
            "properties": {
                "securityRules": [
                    {
                        "name": "RDP",
                        "properties": {
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 300,
                            "direction": "Inbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "NPM",
                        "properties": {
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "8084",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 310,
                            "direction": "Inbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('networkSecurityGroups_vwan_2_nsg_name')]",
            "location": "westeurope",
            "properties": {
                "securityRules": [
                    {
                        "name": "RDP",
                        "properties": {
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 300,
                            "direction": "Inbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "NPM",
                        "properties": {
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "8084",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 310,
                            "direction": "Inbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('networkSecurityGroups_vwan_3_nsg_name')]",
            "location": "westeurope",
            "properties": {
                "securityRules": [
                    {
                        "name": "RDP",
                        "properties": {
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 300,
                            "direction": "Inbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "NPM",
                        "properties": {
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "8084",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 310,
                            "direction": "Inbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups",
            "apiVersion": "2019-09-01",
            "name": "[variables('networkSecurityGroups_vwan_4_nsg_name')]",
            "location": "eastus",
            "properties": {
                "securityRules": [
                    {
                        "name": "RDP",
                        "properties": {
                            "protocol": "TCP",
                            "sourcePortRange": "*",
                            "destinationPortRange": "3389",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 300,
                            "direction": "Inbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    },
                    {
                        "name": "npm",
                        "properties": {
                            "protocol": "*",
                            "sourcePortRange": "*",
                            "destinationPortRange": "8084",
                            "sourceAddressPrefix": "*",
                            "destinationAddressPrefix": "*",
                            "access": "Allow",
                            "priority": 310,
                            "direction": "Inbound",
                            "sourcePortRanges": [],
                            "destinationPortRanges": [],
                            "sourceAddressPrefixes": [],
                            "destinationAddressPrefixes": []
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('publicIPAddresses_vwan_on_prem_gw_pub_ip_name')]",
            "location": "northeurope",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4
            }
        },    
       {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('publicIPAddresses_onprem_vm_pubip_name')]",
            "location": "northeurope",
            "sku": {
                "name": "Basic"
            },
            "properties": {
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Dynamic",
                "idleTimeoutInMinutes": 4,
                "ipTags": []
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('publicIPAddresses_spoke_1_ip_name')]",
            "location": "westeurope",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "ipAddress": "51.105.127.67",
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4,
                "ipTags": []
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('publicIPAddresses_spoke_2_ip_name')]",
            "location": "westeurope",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "ipAddress": "51.105.205.9",
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4,
                "ipTags": []
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('publicIPAddresses_spoke_3_ip_name')]",
            "location": "westeurope",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "ipAddress": "51.105.199.222",
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4,
                "ipTags": []
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2019-09-01",
            "name": "[variables('publicIPAddresses_spoke_4_ip_name')]",
            "location": "eastus",
            "sku": {
                "name": "Standard"
            },
            "properties": {
                "ipAddress": "52.188.177.88",
                "publicIPAddressVersion": "IPv4",
                "publicIPAllocationMethod": "Static",
                "idleTimeoutInMinutes": 4,
                "ipTags": []
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualNetworks_onprem_name')]",
            "location": "northeurope",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "10.0.1.0/24"
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_onprem_name'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_onprem_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_onprem_name'),'GatewaySubnet')]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_onprem_name'),'AzureBastionSubnet')]"
                
            ],
            "properties": {
                "addressPrefix": "10.0.1.0/25"
                
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_onprem_name'), '/GatewaySubnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_onprem_name'))]"
            ],
            "properties": {
                "addressPrefix": "10.0.1.128/27"
                
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_onprem_name'), '/AzureBastionSubnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_onprem_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_onprem_name'),'GatewaySubnet')]"
            ],
            "properties": {
                "addressPrefix": "10.0.1.224/27"
                
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualNetworks_spoke_1_name')]",
            "location": "westeurope",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "172.16.1.0/24"
                    ]
                },
                "enableDdosProtection": false,
                "enableVmProtection": false
            }
        },
        
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_spoke_1_name'), '/subnet1')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_1_name'))]"
            ],
            "properties": {
                "addressPrefix": "172.16.1.0/25"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_spoke_1_name'), '/AzureBastionSubnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_1_name'))]"
            ],
            "properties": {
                "addressPrefix": "172.16.1.128/27"
            }
        },
        


        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualNetworks_spoke_2_name')]",
            "location": "westeurope",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "172.16.2.0/24"
                    ]
                },
                "virtualNetworkPeerings": [
                    {
                        "name": "Spoke2ToHubPeering",
                        "properties": {
                            "peeringState": "Connected",
                            "remoteVirtualNetwork": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks',variables('virtualHubs_Demo_WE_Hub_name'))]"
                            },
                            "allowVirtualNetworkAccess": true,
                            "allowForwardedTraffic": false,
                            "allowGatewayTransit": false,
                            "useRemoteGateways": false,
                            "remoteAddressSpace": {
                                "addressPrefixes": [
                                    "192.168.0.0/24"
                                ]
                            }
                        }
                    }
                ],
                "enableDdosProtection": false,
                "enableVmProtection": false
            }
        }, 
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_spoke_2_name'), '/subnet1')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_2_name'))]"
            ],
            "properties": {
                "addressPrefix": "172.16.2.0/25"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_spoke_2_name'), '/AzureBastionSubnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_2_name'))]"
            ],
            "properties": {
                "addressPrefix": "172.16.2.128/27"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualNetworks_spoke_3_name')]",
            "location": "westeurope",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "172.16.3.0/24"
                    ]
                },
                "virtualNetworkPeerings": [
                    {
                        "name": "Spoke3ToHubPeering",
                        "properties": {
                            "peeringState": "Connected",
                            "remoteVirtualNetwork": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks',variables('virtualHubs_Demo_WE_Hub_name'))]"
                            },
                            "allowVirtualNetworkAccess": true,
                            "allowForwardedTraffic": false,
                            "allowGatewayTransit": false,
                            "useRemoteGateways": false,
                            "remoteAddressSpace": {
                                "addressPrefixes": [
                                    "192.168.0.0/24"
                                ]
                            }
                        }
                    }
                ],
                "enableDdosProtection": false,
                "enableVmProtection": false
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_spoke_3_name'), '/subnet1')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_3_name'))]"
            ],
            "properties": {
                "addressPrefix": "172.16.3.0/25"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_spoke_3_name'), '/AzureBastionSubnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_3_name'))]"
            ],
            "properties": {
                "addressPrefix": "172.16.3.128/27"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualNetworks_spoke_4_name')]",
            "location": "eastus",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "172.16.4.0/24"
                    ]
                },
                "virtualNetworkPeerings": [
                    {
                        "name": "Spoke4ToHubPeering",
                        "properties": {
                            "peeringState": "Connected",
                            "remoteVirtualNetwork": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks',variables('virtualHubs_Demo_WE_Hub_name'))]"
                            },
                            "allowVirtualNetworkAccess": true,
                            "allowForwardedTraffic": false,
                            "allowGatewayTransit": false,
                            "useRemoteGateways": false,
                            "remoteAddressSpace": {
                                "addressPrefixes": [
                                    "192.168.0.0/24"
                                ]
                            }
                        }
                    }
                ],
                "enableDdosProtection": false,
                "enableVmProtection": false
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_spoke_4_name'), '/default')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_4_name'))]"
            ],
            "properties": {
                "addressPrefix": "172.16.4.0/25"
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks/subnets",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('virtualNetworks_spoke_4_name'), '/AzureBastionSubnet')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_4_name'))]"
            ],
            "properties": {
                "addressPrefix": "172.16.4.224/27"
            }
        },    
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "apiVersion": "2019-03-01",
            "name": "[concat(variables('virtualMachines_onprem_name'), '/AzureNetworkWatcherExtension')]",
            "location": "northeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachines_onprem_name'))]"
            ],
            "properties": {
                "autoUpgradeMinorVersion": true,
                "publisher": "Microsoft.Azure.NetworkWatcher",
                "type": "NetworkWatcherAgentWindows",
                "typeHandlerVersion": "1.4"
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "apiVersion": "2019-03-01",
            "name": "[concat(variables('virtualMachines_vwan_1_name'), '/AzureNetworkWatcherExtension')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachines_vwan_1_name'))]"
            ],
            "properties": {
                "autoUpgradeMinorVersion": true,
                "publisher": "Microsoft.Azure.NetworkWatcher",
                "type": "NetworkWatcherAgentWindows",
                "typeHandlerVersion": "1.4"
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "apiVersion": "2019-03-01",
            "name": "[concat(variables('virtualMachines_vwan_2_name'), '/AzureNetworkWatcherExtension')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachines_vwan_2_name'))]"
            ],
            "properties": {
                "autoUpgradeMinorVersion": true,
                "publisher": "Microsoft.Azure.NetworkWatcher",
                "type": "NetworkWatcherAgentWindows",
                "typeHandlerVersion": "1.4"
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "apiVersion": "2019-03-01",
            "name": "[concat(variables('virtualMachines_vwan_3_name'), '/AzureNetworkWatcherExtension')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachines_vwan_3_name'))]"
            ],
            "properties": {
                "autoUpgradeMinorVersion": true,
                "publisher": "Microsoft.Azure.NetworkWatcher",
                "type": "NetworkWatcherAgentWindows",
                "typeHandlerVersion": "1.4"
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "apiVersion": "2019-03-01",
            "name": "[concat(variables('virtualMachines_vwan_4_name'), '/AzureNetworkWatcherExtension')]",
            "location": "eastus",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('virtualMachines_vwan_4_name'))]"
            ],
            "properties": {
                "autoUpgradeMinorVersion": true,
                "publisher": "Microsoft.Azure.NetworkWatcher",
                "type": "NetworkWatcherAgentWindows",
                "typeHandlerVersion": "1.4"
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('networkSecurityGroups_vwan_4_nsg_name'), '/npm')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_4_nsg_name'))]"
            ],
            "properties": {
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "8084",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 310,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('networkSecurityGroups_vwan_1_nsg_name'), '/NPM')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_1_nsg_name'))]"
            ],
            "properties": {
                "protocol": "TCP",
                "sourcePortRange": "*",
                "destinationPortRange": "8084",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 310,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('networkSecurityGroups_vwan_2_nsg_name'), '/NPM')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_2_nsg_name'))]"
            ],
            "properties": {
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "8084",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 310,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('networkSecurityGroups_vwan_3_nsg_name'), '/NPM')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_3_nsg_name'))]"
            ],
            "properties": {
                "protocol": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "8084",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 310,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('networkSecurityGroups_onprem_nsg_name'), '/RDP')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_onprem_nsg_name'))]"
            ],
            "properties": {
                "protocol": "TCP",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 300,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('networkSecurityGroups_vwan_1_nsg_name'), '/RDP')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_1_nsg_name'))]"
            ],
            "properties": {
                "protocol": "TCP",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 300,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('networkSecurityGroups_vwan_2_nsg_name'), '/RDP')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_2_nsg_name'))]"
            ],
            "properties": {
                "protocol": "TCP",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 300,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('networkSecurityGroups_vwan_3_nsg_name'), '/RDP')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_3_nsg_name'))]"
            ],
            "properties": {
                "protocol": "TCP",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 300,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
        },
        {
            "type": "Microsoft.Network/networkSecurityGroups/securityRules",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('networkSecurityGroups_vwan_4_nsg_name'), '/RDP')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_4_nsg_name'))]"
            ],
            "properties": {
                "protocol": "TCP",
                "sourcePortRange": "*",
                "destinationPortRange": "3389",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "*",
                "access": "Allow",
                "priority": 300,
                "direction": "Inbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-03-01",
            "name": "[variables('virtualMachines_onprem_name')]",
            "location": "northeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_onprem_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_D2s_v3"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2016-Datacenter",
                        "version": "latest"
                    },
                    "osDisk": {
                         "createOption": "FromImage"
                    }
                },
                "osProfile": {
                    "computerName": "[variables('virtualMachines_onprem_name')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "windowsConfiguration": {
                        "provisionVMAgent": true,
                        "enableAutomaticUpdates": true
                    },
                    "allowExtensionOperations": true
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_onprem_name'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": false                        
                    }
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-03-01",
            "name": "[variables('virtualMachines_vwan_1_name')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_vwan_1_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_D4s_v3"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2016-Datacenter",
                        "version": "latest"
                    },
                    "osDisk": {
                        "createOption": "FromImage"
                      }                 
                },
                "osProfile": {
                    "computerName": "[variables('virtualMachines_vwan_1_name')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "windowsConfiguration": {
                        "provisionVMAgent": true,
                        "enableAutomaticUpdates": true
                    },
                    "allowExtensionOperations": true
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_vwan_1_name'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": false
                    }
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-03-01",
            "name": "[variables('virtualMachines_vwan_2_name')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_vwan_2_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_D4s_v3"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2016-Datacenter",
                        "version": "latest"
                    },
                    "osDisk": {
                        "createOption": "FromImage"                       
                    }
                },
                "osProfile": {
                    "computerName": "[variables('virtualMachines_vwan_2_name')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "windowsConfiguration": {
                        "provisionVMAgent": true,
                        "enableAutomaticUpdates": true
                    },
                    "allowExtensionOperations": true
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_vwan_2_name'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": false                    }
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-03-01",
            "name": "[variables('virtualMachines_vwan_3_name')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_vwan_3_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_D4s_v3"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2016-Datacenter",
                        "version": "latest"
                    },
                    "osDisk": {          
                        "createOption": "FromImage"
                        }
                    
                },
                "osProfile": {
                    "computerName": "[variables('virtualMachines_vwan_3_name')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "windowsConfiguration": {
                        "provisionVMAgent": true,
                        "enableAutomaticUpdates": true
                    },
                    "allowExtensionOperations": true
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_vwan_3_name'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": false
                    }
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "apiVersion": "2019-03-01",
            "name": "[variables('virtualMachines_vwan_4_name')]",
            "location": "eastus",
            "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_vwan_4_name'))]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "Standard_D4s_v3"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftWindowsServer",
                        "offer": "WindowsServer",
                        "sku": "2016-Datacenter",
                        "version": "latest"
                    },
                    "osDisk": {
                        "createOption": "FromImage"
                        }
                    
                },
                "osProfile": {
                    "computerName": "[variables('virtualMachines_vwan_4_name')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "windowsConfiguration": {
                        "provisionVMAgent": true,
                        "enableAutomaticUpdates": true
                    },
                    "allowExtensionOperations": true
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaces_vwan_4_name'))]"
                        }
                    ]
                },
                "diagnosticsProfile": {
                    "bootDiagnostics": {
                        "enabled": false                    }
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('networkInterfaces_onprem_name')]",
            "location": "northeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_onprem_name'), 'default')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_onprem_nsg_name'))]",
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_onprem_vm_pubip_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAddress": "10.0.1.4",
                            "privateIPAllocationMethod": "Dynamic",
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_onprem_vm_pubip_name'))]"
                            },
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_onprem_name'), 'default')]"
                            },
                            "primary": true,
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": false,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_onprem_nsg_name'))]"
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('networkInterfaces_vwan_1_name')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_1_name'), 'subnet1')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_1_nsg_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAddress": "172.16.1.4",
                            "privateIPAllocationMethod": "Static",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_1_name'), 'subnet1')]"
                            },
                            "primary": true,
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": false,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_1_nsg_name'))]"
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('networkInterfaces_vwan_2_name')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_2_name'), 'subnet1')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_2_nsg_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAddress": "172.16.2.4",
                            "privateIPAllocationMethod": "Static",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_2_name'), 'subnet1')]"
                            },
                            "primary": true,
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": false,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_2_nsg_name'))]"
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('networkInterfaces_vwan_3_name')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_3_name'), 'subnet1')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_3_nsg_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAddress": "172.16.3.4",
                            "privateIPAllocationMethod": "Static",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_3_name'), 'subnet1')]"
                            },
                            "primary": true,
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": false,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_3_nsg_name'))]"
                }
            }
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "apiVersion": "2019-09-01",
            "name": "[variables('networkInterfaces_vwan_4_name')]",
            "location": "eastus",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_4_name'), 'default')]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_4_nsg_name'))]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAddress": "172.16.4.4",
                            "privateIPAllocationMethod": "Dynamic",
                            "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_4_name'), 'default')]"
                            },
                            "primary": true,
                            "privateIPAddressVersion": "IPv4"
                        }
                    }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false,
                "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroups_vwan_4_nsg_name'))]"
                }
            }
        },
        {
            "type": "Microsoft.Network/virtualWans",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualWans_Demo_vWAN_name')]",
            "location": "westeurope",
            "properties": {
                "disableVpnEncryption": false,
                "allowBranchToBranchTraffic": true,
                "allowVnetToVnetTraffic": false,
                "office365LocalBreakoutCategory": "None",
                "type": "Standard"
            }
        },    
        {
            "type": "Microsoft.Network/virtualHubs",
            "apiVersion": "2019-09-01",
            "name": "[variables('virtualHubs_Demo_WE_Hub_name')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_1_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_1_name'),'subnet1')]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_1_name'),'AzureBastionSubnet')]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_2_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_2_name'),'subnet1')]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_2_name'),'AzureBastionSubnet')]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_3_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_3_name'),'subnet1')]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_3_name'),'AzureBastionSubnet')]",
                "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_4_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_4_name'), 'default')]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('virtualNetworks_spoke_4_name'), 'AzureBastionSubnet')]",
                "[resourceId('Microsoft.Network/virtualWans', variables('virtualWans_Demo_vWAN_name'))]"
            ],
            "properties": {
                "virtualNetworkConnections": [
                    {
                        "name": "hub-spoke1",                      
                        "properties": {
                            "remoteVirtualNetwork": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_1_name'))]"
                            },
                            "allowHubToRemoteVnetTransit": true,
                            "allowRemoteVnetToUseHubVnetGateways": true,
                            "enableInternetSecurity": true
                        }
                    },
                    {
                        "name": "hub-spoke2",
                        "properties": {
                            "remoteVirtualNetwork": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_2_name'))]"
                            },
                            "allowHubToRemoteVnetTransit": true,
                            "allowRemoteVnetToUseHubVnetGateways": true,
                            "enableInternetSecurity": true
                        }
                    },
                    {
                        "name": "hub-spoke3",
                        "properties": {
                            "remoteVirtualNetwork": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_3_name'))]"
                            },
                            "allowHubToRemoteVnetTransit": true,
                            "allowRemoteVnetToUseHubVnetGateways": true,
                            "enableInternetSecurity": true
                        }
                    },
                    {
                        "name": "spoke-4",
                        "properties": {
                            "remoteVirtualNetwork": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks', variables('virtualNetworks_spoke_4_name'))]"
                            },
                            "allowHubToRemoteVnetTransit": true,
                            "allowRemoteVnetToUseHubVnetGateways": true,
                            "enableInternetSecurity": true
                        }
                    }
                ],
                
                "virtualHubRouteTableV2s": [],
                "addressPrefix": "192.168.0.0/24",
                "routeTable": {
                    "routes": []
                },
                "virtualWan": {
                    "id": "[resourceId('Microsoft.Network/virtualWans', variables('virtualWans_Demo_vWAN_name'))]"
                }
            }
        },
        {
            "type": "Microsoft.Network/vpnGateways",
            "apiVersion": "2019-09-01",
            "name": "[variables('vpnGateways_westeurope_gw_name')]",
            "location": "westeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Network/vpnSites', variables('vpnSites_Onprem_1_name'))]",
                "[resourceId('Microsoft.Network/virtualHubs', variables('virtualHubs_Demo_WE_Hub_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_vwan_on_prem_gw_name'))]"
            ],
            "properties": {
                "connections": [
                    {
                        "name": "Connection-Onprem-1",
                        "properties": {
                            "remoteVpnSite": {
                                "id": "[resourceId('Microsoft.Network/vpnSites', variables('vpnSites_Onprem_1_name'))]"
                            },
                            "enableInternetSecurity": false,
                            "vpnLinkConnections": [
                                {
                                    "name": "Onprem-gwConnection",
                                    "properties": {
                                        "vpnSiteLink": {
                                            "id": "[concat(resourceId('Microsoft.Network/vpnSites', variables('vpnSites_Onprem_1_name')), '/vpnSiteLinks/Onprem-gw')]"
                                        },
                                        "connectionBandwidth": 10,
                                        "ipsecPolicies": [],
                                        "vpnConnectionProtocolType": "IKEv2",
                                        "enableBgp": false,
                                        "enableRateLimiting": false,
                                        "useLocalAzureIpAddress": false,
                                        "usePolicyBasedTrafficSelectors": false,
                                        "routingWeight": 0
                                    }
                                }
                            ]
                        }
                    }
                ],
                "virtualHub": {
                    "id": "[resourceId('Microsoft.Network/virtualHubs', variables('virtualHubs_Demo_WE_Hub_name'))]"
                },
                "bgpSettings": {
                    "asn": 65515,
                    "peerWeight": 0
                },
                "vpnGatewayScaleUnit": 1
            }
        },
        {
            "type": "Microsoft.Network/vpnSites",
            "apiVersion": "2019-09-01",
            "name": "[variables('vpnSites_Onprem_1_name')]",
            "location": "northeurope",
            "dependsOn": [
                "[resourceId('Microsoft.Network/virtualWans', variables('virtualWans_Demo_vWAN_name'))]",
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddresses_vwan_on_prem_gw_pub_ip_name'))]"

            ],
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "10.0.1.0/24"
                    ]
                },
                "deviceProperties": {
                    "deviceVendor": "Azure",
                    "linkSpeedInMbps": 0
                },
                "virtualWan": {
                    "id": "[resourceId('Microsoft.Network/virtualWans', variables('virtualWans_Demo_vWAN_name'))]"
                },
                "isSecuritySite": false,
                "vpnSiteLinks": [
                    {
                        "name": "Onprem-gw",
                        "properties": {
                            "ipAddress": "[reference(variables('publicIPAddresses_vwan_on_prem_gw_pub_ip_name')).IpAddress]",
                            "linkProperties": {
                                "linkProviderName": "Azure",
                                "linkSpeedInMbps": 100
                            }
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/vpnGateways/vpnConnections",
            "apiVersion": "2019-09-01",
            "name": "[concat(variables('vpnGateways_westeurope_gw_name'), '/Connection-Onprem-1')]",
            "dependsOn": [
                "[resourceId('Microsoft.Network/vpnGateways', variables('vpnGateways_westeurope_gw_name'))]",
                "[resourceId('Microsoft.Network/vpnSites', variables('vpnSites_Onprem_1_name'))]",
                "[resourceId('Microsoft.Network/virtualNetworkGateways', variables('virtualNetworkGateways_vwan_on_prem_gw_name'))]"
            ],
            "properties": {
                "remoteVpnSite": {
                    "id": "[resourceId('Microsoft.Network/vpnSites', variables('vpnSites_Onprem_1_name'))]"
                },
                "enableInternetSecurity": false,
                "vpnLinkConnections": [
                    {
                        "name": "Onprem-gwConnection",
                        "properties": {
                            "vpnSiteLink": {
                                "id": "[concat(resourceId('Microsoft.Network/vpnSites', variables('vpnSites_Onprem_1_name')), '/vpnSiteLinks/Onprem-gw')]"
                            },
                            "connectionBandwidth": 10,
                            "ipsecPolicies": [],
                            "vpnConnectionProtocolType": "IKEv2",
                            "enableBgp": false,
                            "enableRateLimiting": false,
                            "useLocalAzureIpAddress": false,
                            "usePolicyBasedTrafficSelectors": false,
                            "routingWeight": 0
                        }
                    }
                ]
            }
        }
    ]
}